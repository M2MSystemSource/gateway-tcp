/**
 * Filtra los datos de la posición si fuera necesario
 * @type {Object}
 */

/**
 * Listado de dispositivos a filtrar, con el filtro que se les aplicará
 * @type {Object}
 */
const devicesToFilter = {
  vinRectifier: [
    // movus (250)
    '867717036843176', '867717036807080', '867717036843663', '867717036804772', '867717036848837',
    '867717036804848', '867717036774850', '867717036809961', '867717036788538', '867717036851088',
    '867717036804202', '867717036774975', '867717036842202', '867717036851757', '867717036851179',
    '867717036851682', '867717036851781', '867717036797703', '867717036851740', '867717036843010',
    '867717036798214', '867717036797729', '867717036775238', '867717036799063', '867717036842541',
    '867717036851708', '867717036797802', '867717036797828', '867717036843879', '867717036797752',
    '867717036798099', '867717036851070', '867717036809979', '867717036804145', '867717036776806',
    '867717036850460', '867717036776814', '867717036848878', '867717036851732', '867717036843093',
    '867717036851096', '867717036807205', '867717036805159', '867717036825843', '867717036851187',
    '867717036851138', '867717036842277', '867717036810233', '867717036851690', '867717036851823',
    '867717036797760', '867717036841949', '867717036840198', '867717036841709', '867717036851674',
    '867717036797737', '867717036797786', '867717036804558', '867717036840156', '867717036843648',
    '867717036798487', '867717036844257', '867717036774967', '867717036813021', '867717036798073',
    '867717036804509', '867717036842574', '867717036775154', '867717036851047', '867717036840099',
    '867717036840149', '867717036842152', '867717036775014', '867717036775139', '867717036851161',
    '867717036843101', '867717036842566', '867717036844083', '867717036804541', '867717036842517',
    '867717036842160', '867717036760560', '867717036841766', '867717036774942', '867717036802859',
    '867717036775279', '867717036851567', '867717036851062', '867717036804608', '867717036851146',
    '867717036841642', '867717036775329', '867717036839935', '867717036851153', '867717036808054',
    '867717036805548', '867717036850288', '867717036840867', '867717036804830', '867717036842533',
    '867717036841170', '867717036851195', '867717036843259', '867717036804574', '867717036776830',
    '867717036850429', '867717036844471', '867717036842038', '867717036839968', '867717036851120',
    '867717036842897', '867717036843184', '867717036842228', '867717036844422', '867717036841618',
    '867717036841238', '867717036851716', '867717036797711', '867717036842954', '867717036851724',
    '867717036775311', '867717036842210', '867717036804954', '867717036851021', '867717036798222',
    '867717036851773', '867717036805241', '867717036804996', '867717036841154', '867717036775204',
    '867717036775188', '867717036804582', '867717036807155', '867717036842145', '867717036849306',
    '867717036844042', '867717036805001', '867717036842137', '867717036798230', '867717036851765',
    '867717036832872', '867717036804590', '867717036851104', '867717036844059', '867717036798396',
    '867717036844273', '867717036804467', '867717036841246', '867717036775170', '867717036842285',
    '867717036842004', '867717036775162', '867717036842590', '867717036843044', '867717036841113',
    '867717036844232', '867857039618280', '867717036843218', '867717036845056', '867717036843721',
    '867717036798644', '867717036842269', '867717036842319', '867717036798529', '867717036843887',
    '867717036842087', '867717036843747', '867717036842582', '867717036843762', '867857039545293',
    '867717036843283', '867717036843309', '867717036842327', '867717036843473', '867717036842103',
    '867717036843796', '867857039614834', '867717036849272', '867857039617845', '867857039614776',
    '867857039616094', '867857039617803', '867857039545483', '867857039617159', '867717036843895',
    '867857039617233', '867857039616698', '867857039545301', '867717036843812', '867717036842178',
    '867857039545798', '867857039617126', '867857039617100', '867857039617381', '867857039616409',
    '867857039617357', '867857039618215', '867857039614867', '867857039617373', '867857039617241',
    '867857039617209', '867857039618223', '867717036843820', '867857039617811', '867857039617092',
    '867857039617118', '867857039617779', '867717036798198', '867717036851799', '867857039377143',
    '867857039381228', '867857039384057', '867857039381640', '867857039518837', '867857039381608',
    '867857039519140', '867857039614750', '867857039381236', '867857039616151', '867857039617225',
    '867857039518712', '867857039518654', '867857039383786', '867857039616128', '867857039383687',
    '867857039545467', '867857039518803', '867857039545517', '867857039431098', '867857039518647',
    '867857039383893', '867857039381343', '867857039383919', '867857039381483', '867857039383869',
    '867857039615039', '867857039383968', '867857039518951', '867857039518860', '867857039518845',
    '867857039614826', '867857039518985', '867857039383513', '867857039518761', '867857039616078',
    '867857039616086', '867857039381301', '867857039614784', '861510030799262',

    // up2city (52)
    '867717036798487', '867717036798073', '867857039614842', '867857039383703', '867857039488833',
    '867857039421123', '867857039381657', '867857039395939', '867717036840230', '867857039431247',
    '867857039381533', '867857039617829', '867857039614859', '867717036843903', '867857039432039',
    '867857039383166', '867857039510230', '867857039425959', '867857039380113', '867857039383844',
    '867857039383752', '867857039519132', '867857039431346', '867857039426395', '867857039381475',
    '867717036843697', '867857039428128', '867857039383497', '867857039614875', '867857039425827',
    '867857039381210', '867857039383729', '867857039519033', '867857039519058', '867717036843788',
    '867857039518704', '867857039383158', '867857039382820', '867857039381392', '867857039383885',
    '867857039396515', '867857039381434', '867857039383182', '867857039384024', '867857039430926',
    '867857039518696', '867857039426221', '867857039518977', '867857039518969', '867857039381699'
  ]
}

module.exports = (app) => {
  /**
   * Los filtros se presentan como métodos con el mismo nombre que alguna de
   * las opciones de devicesToFilter
   * @type {Object}
   */
  const filters = {
    /**
     * Rectifica el valor de la batería externa (position.data.extra) para
     * compensar el fallo en el firmware de estos dispositivos por el cual
     * se obtienen valores negativos en batería
     * @param  {Object} position Posición según modelo de datos en la Api
     * @return {Object}          Posición rectificada
     */
    vinRectifier: (position) => {
      const intLimit = 32767 // valor máximo del tipo de dato INT en chips de 8bits
      const vin = parseInt(position.data.extra, 10) // vIn original de la posición

      // si es negativo aplicamos fórmula para compensar el desbordamiento de
      // variable int en firmware
      if (vin < 0) {
        const x = vin + intLimit
        position.data.extra = x + intLimit

      // si es menor que 9000 indica un valor de lectura residual, lo dejamos a cero
      } else if (vin < 9000) {
        position.data.extra = 0
      }

      return position
    }
  }

  /**
   * Buscamos en devicesToFilter si el dispositivo tiene algún filtro asociado
   * y aplicamos el filtro
   * @param  {Object} device   Dispositivo según modelo de datos en la Api
   * @param  {Object} position Posición según modelo de datos en la Api
   * @return {Object}          Posición rectificada
   */
  return (device, position) => {
    Object.keys(devicesToFilter).forEach((filter) => {
      if (!filters.hasOwnProperty(filter)) return
      if (devicesToFilter[filter].indexOf(device._id) === -1) return
      position = filters[filter](position)
    })

    return position
  }
}
